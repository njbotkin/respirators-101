<div class="search" data-active="{ !!search }">
	<input bind:value=search type="text" id="search" placeholder="Search" />
	<div class="closeSearch" on:click="set({ search: '' })">Ã—</div>
</div>

<div class="container">
	{ #if search !== '' }
		<div class="results">
			{ #if results.length > 0 }
				{ #each results as r }
					<Chemical highlight="true" c="{ r.item }"></Chemical>
				{ /each }
			{ :else }
				<div class="empty">No search results.</div>
			{ /if }
		</div>
	{ :else }
		<div class="chemicals">
			{ #each results as c, i }
				{ #if c.id }
					<div class="letter-heading">{ c.id }</div>
				{ /if }
				<Chemical {c} bind:open=$openChemicals[i]></Chemical>
			{ /each }
		</div>

		<div class="alphabet">
			{ #each letters as l }
				<div class="letter">{ l }</div>
			{ /each }
		</div>
	{ /if }
</div>

<style>
	.search {
		height: 50px;
		position: relative;
		padding: 10px;
		box-sizing: border-box;

		input {
			line-height: 30px;
			display: block;
			width: auto;
			padding: 0 10px;
			box-sizing: border-box;
			width: 100%;
			border: 1px solid #999;
			font-size: 120%;
		}

		&:after {
			position: absolute;
			right: 11px;
			top: 11px;
			display:inline-block;
			width: 30px;
			line-height: 30px;
			z-index: 2;
			text-align: center;
			color: #999;

			content: "\f002";
			/* use !important to prevent issues with browser extensions that change fonts */
			font-family: 'icomoon' !important;
			speak: none;
			font-style: normal;
			font-weight: normal;
			font-variant: normal;
			text-transform: none;

			/* Better Font Rendering =========== */
			-webkit-font-smoothing: antialiased;
			-moz-osx-font-smoothing: grayscale;
		}

		.closeSearch {
			cursor: pointer;
			display: none;
			width: 30px;
			text-align: center;
			position: absolute;
			top: 11px;
			right: 11px;
			font-size: 30px;
			line-height: 30px;
			z-index: 2;
		}

		&[data-active=true] {
			.closeSearch {
				display: block;
			}
			&:after {
				display: none;
			}
		}

	}
	.empty {
		font-size: 120%;
		color: #666;
		padding: 20px;
		text-align: center;
	}
	.letter-heading {
		font-size: 240%;
		text-transform: uppercase;
		padding-left: 10px;
	}
	.container {
		position: absolute;
		top: 50px;
		right: 0;
		bottom: 0;
		left: 0;

		.chemicals {
			position: absolute;
			top: 0;
			left: 0;
			bottom: 0;
			right: calc(2.65vh - 2.65px + 16px );
			overflow-y: scroll;
			overflow-x: hidden;
		}
		.alphabet {
			position: absolute;
			top: 0;
			right: 0;
			bottom: 0;
			font-size: calc(2.65vh - 2.65px ); 
			overflow: hidden;

			div {
				user-select: none;
				cursor: pointer;
				width: calc(2.65vh - 2.65px );
				padding: 0 8px;
				text-transform: uppercase;

				&.active {
					background: #ddd;
				}
			}
		}
	}
	
</style> 

<script>

	import chemicals from 'data/chemicals.json'
	import Fuse from 'fuse.js'  
	import Chemical from 'lib/Chemical.html'
	import { job } from 'lib/storage.js'

	// I know this seems hacky.  Sorting chemicals by name is pretty arbitrary, what with the alpha- 1,2,3- o- style prefixes.  I'm not going to build a hideous regex for this.  The data source is already mostly sorted alphabetically, so I'm just picking up on the existing order.
	const letters = 'abcdefghiklmnopqrstuvwxyz'.split('') // no J chemicals
	var letter = 0

	// link letter in navigation to first chemical that starts with it
	for(var c of chemicals) {
		if(c.name.slice(0, 1).toLowerCase() === letters[letter] && c.name.slice(1, 2) !== '-') {
			c.id = letters[letter]
			letter++
		}
	}

	var fuse = new Fuse(chemicals, {
		keys: [
			{
				name: 'name',
				weight: 0.7
			}, 
			{
				name: 'synonyms',
				weight: 0.5
			},
			{
				name: 'cas',
				weight: 0.9
			}
		],
		shouldSort: true,
		includeScore: true,
		includeMatches: true,
		threshold: 0.4,
	})

	export default {
		components: {
			Chemical
		},
		data: () => ({
			search: '',
			letters
		}),
		store: () => job,
		oncreate() {

			// scrolling through alphabet thingy
			let container = container

			// would like to do this with CSS...
			function adjustAlphabetHeight() {
				var height = window.document.querySelector('.alphabet').getBoundingClientRect().height
				var fontSize = height / 25 / 1.5 // height / # of letters / line height
				document.querySelector('.alphabet').style.fontSize = `${fontSize}px`
			}

			window.addEventListener('resize', adjustAlphabetHeight)
			adjustAlphabetHeight()


			var mouseDown = false

			container.addEventListener('mousedown', down)
			container.addEventListener('touchstart', down)
			container.addEventListener('mouseup', up)
			container.addEventListener('touchend', up)
			container.addEventListener('touchcancel', up)

			function down(e) {
				if(e.target.className.indexOf('letter') > -1) {
					mouseDown = true
				}
			}

			function up() {
				mouseDown = false

				for(var l of document.querySelectorAll('.letter')) {
					l.classList.remove('active')
				}
			}

			container.addEventListener('mousemove', selectLetter)
			container.addEventListener('touchmove', selectLetter)
			container.addEventListener('click', selectLetter)

			function selectLetter(e) {

				var target

				if(e.type == 'touchmove') {
					let myLocation = e.touches[0];
					target = document.elementFromPoint(myLocation.clientX, myLocation.clientY);
				} else {
					target = e.target
				}

				if(mouseDown || e.type == 'click') {

					if(target.className && target.className.indexOf('letter') > -1) {

						e.preventDefault()

						var chemicalBox = document.querySelector('.chemicals')
						var chemicalBoxOffset = chemicalBox.getBoundingClientRect()

						for(var l of document.querySelectorAll('.letter')) {
							l.classList.remove('active')
						}
						target.classList.add('active')

						var chemical = document.getElementById(target.innerText.toLowerCase())

						if(chemical) {
							var scrollTop = chemicalBox.scrollTop + chemical.getBoundingClientRect().top - chemicalBoxOffset.top - chemicalBoxOffset.height/3
							chemicalBox.scrollTop = scrollTop
						}

					}

				}
			}

			let chemicals = document.querySelector('.chemicals')
			if(job.get().chemicalsScrollTop) {
				chemicals.scrollTop = job.get().chemicalsScrollTop
			}

			chemicals.addEventListener('scroll', () => {
				job.set({ chemicalsScrollTop: chemicals.scrollTop })
			})

		},
		computed: {
			results: ({ search }) => {

				if(search === '') {
					return chemicals
				} 

				var results = fuse.search(search)
					.filter(r => {
						var emptyMatches = r.matches.filter(m => m.value === '')
						return emptyMatches.length < r.matches.length
					})
					.slice(0, 50) // maximum number for rendering speed

				for(var r of results) {
					for(var m of r.matches) {

						var highlit = ''

						if(m.indices.length > 0) {

							highlit += m.value.slice(0, m.indices[0][0])

							for(var i = 0; i < m.indices.length; i++) {
								let indice = m.indices[i]
								
								highlit += '<em>' + m.value.slice(indice[0], indice[1]+1) + '</em>'
								if(i+1 < m.indices.length) {
									highlit += m.value.slice(indice[1]+1, m.indices[i+1][0])
								}							
							}

							highlit += m.value.slice(m.indices[m.indices.length-1][1]+1)
						}

						r.item[m.key + 'Highlit'] = highlit
					}
				}

				return results
			}
		}
	}

</script>