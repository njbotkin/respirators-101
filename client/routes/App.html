<div class="maxwidth">

	<div class="wrapper shifted{ shifted }">

		<div class="left">
			<div class="appname">Respirators 101</div>
			<div class="main">
				<Menu asr="{ asr }"></Menu>
			</div>
		</div>

		<div class="right">
			<div class="elsewhere"></div>

			<nav>
				{ #if categoryParent }
					<a class="back nav-button icon-angle-left" href="{ categoryParent }">back</a>
				{ :elseif backButton }
					<a class="back nav-button icon-angle-left" href="javascript:window.history.go(-1);">back</a>
				{ /if }

				<div class="nav-button close icon-close">close menu</div>
				<div class="nav-button menu icon-menu">open menu</div>

				<div class="title"><div class="inner">{ title }</div></div>

				<a class="nav-button home icon-home2" href="{ asr.makePath('app.home') }">go home</a>
			</nav>

			<div class="main">
				<uiView></uiView>
			</div>

			<div id="domlog"></div>

			{ #if $job.RSLStep && (stateName !== 'app.respirator-picker') && (stateName !== 'app.options-list')  }
			<a class="button in-selection" href="{ asr.makePath('app.respirator-picker', {id: $job.RSLStep})}">
				Resume Respirator Selection
			</a>
			{ /if }

			<div class="button current-job visible{ /app\.((calculate\-)|(respirator\-)|(chemicals))/.test(stateName) }"> Current Job </div>
		</div>

		<div class="bottom">
			
			<div class="job" bind:offsetHeight="jobHeight">
				<Job bind:job="$job" {asr} only="true" />
			</div>

		</div>

	</div>

</div>

<script>

	import Menu from 'lib/Menu.html'
	import categories from 'data/categories.json'
	import posts from 'data/posts.json'
	import { store } from 'lib/storage.js'
	import Job from './info/Job.html'

	export default {
		components: {
			Menu,
			Job
		},
		store: () => store,
		oncreate () {

			// console.log = console.error = m => {
			// 	let div = document.createElement('div')
			// 	div.innerText = m 
			// 	document.getElementById('domlog').appendChild(div)
			// }

			const wrapper = document.querySelector('.wrapper')
			wrapper.next = {x: -300, y: 0}

			var animationStarted = 0
			var start = {x: 0, y: 0}
			var end = {x: 0, y: 0}
			var animationDuration = 250 // quarter second

			function direction({x, y}) {
				let threshold = 1 // pixels (arbitrary)
				if(x - Math.abs(y) > threshold) return 'right'
				else if(y - Math.abs(x) > threshold) return 'down'
				else if(Math.abs(x) - Math.abs(y) > threshold) return 'left'
				else if(Math.abs(y) - Math.abs(x) > threshold) return 'up'
			}

			function animate(e) {
				start = {x: wrapper.x, y: wrapper.y}
				end = e
				animationStarted = Date.now()
			}

			var prev = false, initialDirection = false, movement = {}

			window.addEventListener('touchstart', () => prev = true)
			window.addEventListener('touchend', () => up())
			window.addEventListener('touchcancel', () => up())

			const up = () => {
				prev = false

				// swipe
				if(movement.x == 0 && movement.y == 0)  return

				let latestDirection = direction(movement)

				if(wrapper.y == 0) { //sidebar
					if(latestDirection == 'right') animate({x: 0, y: 0}) // open
					else if(latestDirection == 'left') animate({x: -300, y: 0}) // closed
					else animate({x: wrapper.x > -150 ? 0 : -300, y: 0}) // either side of halfway
				} else {
					// current job
					let height = this.get().jobHeight
					if(latestDirection == 'up') animate({x: -300, y: -height}) // open
					else if(latestDirection == 'down') animate({x: -300, y: 0}) // closed
					else animate({x: -300, y: wrapper.y > -height/2 ? 0 : -height}) // either side of halfway
				}
				movement = {x:0, y:0}
			}

			document.querySelector('.elsewhere').addEventListener('click', () => {
				animate({x: -300, y: 0})
			})

			document.querySelector('.menu.icon-menu').addEventListener('click', () => {
				animate({x: 0, y: 0})
			})

			document.querySelector('.current-job').addEventListener('click', () => {
				let height = this.get().jobHeight
				animate({x: -300, y: -height})
			})

			window.addEventListener('touchmove', e => {
				e.stopPropagation()

				let target = e.touches ? e.touches[0] : e
				let { clientX, clientY } = target

				// first move
 				if(prev === true) {
 					initialDirection = false
					prev = { x: clientX, y: clientY }
					return
				}
				movement.x = clientX - prev.x
				movement.y = clientY - prev.y

				prev = { x: clientX, y: clientY }

				if(!initialDirection) initialDirection = direction(movement)

				// drag around
				if(wrapper.y == 0) { //sidebar
					if(initialDirection == 'right' || initialDirection == 'left') {
						wrapper.next = { x: Math.max(Math.min(wrapper.x + movement.x, 0), -300), y: 0 }
					}
				} else { // current job
					if(initialDirection == 'down' || initialDirection == 'up') {
						let height = this.get().jobHeight
						wrapper.next = { x: -300, y: Math.max(Math.min(wrapper.y + movement.y, 0), -height) }
					}
				}
			})

  			const easeOutCubic = function (t) { return (--t)*t*t+1 } 

			const renderSlide = () => {

				if(wrapper.next.x != wrapper.x || wrapper.next.y != wrapper.y) {
					// manual movement
				} else if(!prev && (wrapper.x != end.x || wrapper.y != end.y) && (start.x !== end.x || start.y !== end.y)) {
					// animation in progress

					let animationElapsed = (Date.now() - animationStarted) / animationDuration

					let ease = animationElapsed < 1 ? easeOutCubic(animationElapsed) : 1
					let move = {
						x: (end.x - start.x) * ease,
						y: (end.y - start.y) * ease
					}
					wrapper.next = {x: start.x + move.x, y: start.y + move.y}
				} else {
					return // nothing to do
				}

				if(wrapper.next.x != -300 || wrapper.next.y !== 0) {
					this.set({shifted: true})
				} else {
					this.set({shifted: false})
				}

				if(wrapper.next.x !== wrapper.x || wrapper.next.y !== wrapper.y) {
					let {x, y} = wrapper.next
					let value = `translate(${x}px, ${y}px)`
					wrapper.style.cssText = `
						-webkit-transform: ${value};
						transform: ${value};`
					wrapper.x = x
					wrapper.y = y
				}
			}

			function render() {
				renderSlide()
				window.requestAnimationFrame(render)
			}
			render()

			// use event bubbling to make all external links open in new tab
			window.addEventListener('click', e => {
				if(e.target.tagName !== 'A') return true
				const a = e.target

				if(a.href && a.host !== window.location.host && a.href.indexOf('javascript:') === -1) {
					e.preventDefault()
					e.stopPropagation() 
					window.open(a.href, '_blank')
				}
			})

			const stateChange = e => {
				var params = e.params

				if(e.state.name == 'app.categorycontent' || e.state.name == 'app.category') {
					if(params.catid && categories[params.catid]) {
						this.set({ title: categories[params.catid].title })
					}
				}

				else if(e.state.name == 'app.content') {
					if(params.id && posts[params.id]) {
						this.set({ title: posts[params.id] })
					}
				}

				else if(e.state.title) {
					this.set({ title: e.state.title })
				}

				else {
					this.set({ title: "" })
				}

				// back button for category contents
				if(params.catid && params.id) {
					this.set({ backButton: false })
					this.set({ categoryParent: this._state.asr.makePath('app.category', { catid: params.catid }) })
				} else if(e.state.route.slice(0, 9) === 'calculate' && e.state.route.length > 9) {
					this.set({ backButton: true })
					this.set({ categoryParent: false })
				} else {
					this.set({ backButton: false })
					this.set({ categoryParent: false })
				}

				animate({x: -300, y: 0})
				this.set({stateName: e.state.name})
			}

			// captures event from router
			this.on('stateChange', stateChange)
			stateChange(this.get().initialState)
		}, 
		data() {
			return { 
				shifted: false,
				title: '',
				inSelection: false,
				stateName: null,
				jobOpen: false,
				jobHeight: 0
			}
		}
	}

</script>

<style>

	@import "colors";

	.maxwidth {
		position:absolute;
		top: 0;
		bottom: 0;
		left: 0;
		right: 0;
		max-width: 800px;
		margin: 0 auto;
		overflow:hidden;
	}

	.wrapper {
		position: absolute;
		top: 0;
		right: 0;
		bottom: 0;
		left: 0;
		width: calc(100% + 300px);

		.left {
			position: absolute;
			top: 0;
			right: calc(100% - 300px); 
			bottom: 0;
			left: 0;
			background: $blue3;
			color: #fff;
			font-size: 14px;
		}

		.right {
			position: absolute;
			top: 0;
			right: 0;
			bottom: 0;
			left: 300px;
			z-index: 3;

			.elsewhere {
				display: none;
				position:absolute;
				top:0;
				right:0;
				bottom:0;
				left:0;
				z-index: 3;
			}

			nav {
				width: 100%;
				height: 50px;
				background: $blue3;

				.title {
					display: table;
					width: 100%;
					.inner {
						display: table-cell;
						text-align: center;
						font-family: "Roboto Condensed";
						text-transform: uppercase;
						color: #fff;
						height: 50px;
						vertical-align: middle;
					}
				}
				.nav-button {
					position: absolute;
					top: 0;
					height: 50px;
					text-indent: -99999px;
					overflow: hidden;
					text-decoration: none;

					&::before {
						text-indent: 0;
						width: 50px;
						font-size: 30px;
						line-height: 50px;
						color: #fff;
						background: $blue3;
						cursor: pointer;
						text-align: center;
						display: block;
					}

					&.back {
						z-index: 2;
						&::before {
							margin-left: -2px;
						}
					}
					&.home {
						right: 0;
					}
				}
			}
		}

		.bottom {
			position: absolute;
			top: 100%;
			left: 300px;
			right: 0;
			background: #fff;
		}

		&.shiftedtrue {

			.right {
				box-shadow: 0px 0px 40px 0px #00000066;
				.elsewhere {
					display: block;
				}
				nav {
					.close {
						z-index: 1;
					}
				}
			}
		}
	}


	.main {
		position: absolute;
		top: 50px;
		right: 0;
		left:0;
		bottom: 0;
		overflow-y: auto;
		overflow-x: hidden;
		padding-bottom: 60px;
	}

	.appname {
		font-family: "Roboto Condensed";
		text-align: left;
		line-height: 50px;
		padding: 0 20px;
		text-transform: uppercase;
		background: $blue5;
	}

	.in-selection {
	    position: absolute;
	    z-index: 2;
	    bottom: 0;
	    max-width: 60%;
	    background: #4c5a8d;
	    padding: 13px 15px 13px 45px;
	    vertical-align: middle;
	    color: #ffffffee;
	    text-decoration: none;
	    background-image: url(icons/respirator.png);
	    background-size: 25px;
	    background-position: 8px center;
	    background-repeat: no-repeat;
	    line-height: 14px;
	    box-sizing: border-box;

	    @media (max-width: 400px) {
	    	padding: 8px 10px 8px 40px;
	    	background-size: 20px;
	    	font-size: 70%;
	    }
	}
	.current-job {
		margin: 0;
		display: none;
		background: $green; 
		position: absolute;
		bottom: 0;
		right: 0;
		z-index: 2;

	    @media (max-width: 400px) {
	    	line-height: 30px;
	    	padding: 0 8px;
	    	font-size: 70%;
	    }

	    &.visibletrue {
	    	display:block;
	    }
	}

	#domlog	{
		position: absolute;
		bottom: 0;
		z-index: 1000;
	}

</style>