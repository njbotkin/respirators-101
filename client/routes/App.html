<svelte:window bind:innerHeight="windowHeight" bind:innerWidth="windowWidth" />

<div class="maxwidth">

	<div class="wrapper { sidebarOpen && 'sidebarOpen' } { $jobOpen && 'jobOpen' }" style="-webkit-transform: translate({ wrapperX }px, 0); transform: translate({ wrapperX }px, 0)">

		<div class="left">
			<div class="appname">Respirators 101 <div class="nav-button close icon-close" on:click="set({ sidebarOpen: false })">close menu</div></div>
			<div class="main" on:click="closeMenu(event)">
				<Menu {asr} />
			</div>
		</div>

		<div class="right">
			<div class="elsewhere" on:click="focusContent()"></div>

			<nav>
				{ #if categoryParent }
					<a class="back nav-button icon-angle-left" href="{ categoryParent }">back</a>
				{ :elseif backButton }
					<a class="back nav-button icon-angle-left" href="javascript:window.history.go(-1);">back</a>
				{ /if }

				<div class="nav-button close icon-close">close menu</div>
				<div class="nav-button menu icon-menu" on:click="set({ sidebarOpen: true })">open menu</div>

				<div class="title"><div class="inner">{ $nav && $nav.title }</div></div>

				<a class="nav-button home icon-home2" href="{ asr.makePath('app.home') }">go home</a>
			</nav>

			{ #if $nav && $nav.sub }
				<div class="rednav" bind:offsetHeight="redNavHeight">
						
					{ #if $nav.sub.prev }<div class="prev"><a class="icon-chevron-circle-left" href="{ $nav.sub.prev }"><span class="text">Previous page</span></a></div>{ /if }

					<div class="title"><div class="inner">{ $nav.sub.title }</div></div>

					{ #if $nav.sub.next }<div class="next"><a class="icon-chevron-circle-right" href="{ $nav.sub.next }"><span class="text">Next page</span></a></div> { /if }

				</div> 
			{ /if }

			<div class="main" id="aperture" style="top: { apertureMarginTop }px; padding-bottom: { showState ? 70 : 0 }px" class:locked=$lockContent>
				<uiView></uiView> 
			</div>

			<div id="domlog"></div>

			{ #if showState }
				<div class="state" bind:offsetHeight="jobHeight" style="-webkit-transform: translate(0, { jobY }px); transform: translate(0, { jobY }px)" on:click="closeJob(event)">

					<div class="header" on:click="$set({ jobOpen: !$jobOpen })">
						<div class="current-job" bind:offsetWidth="currentJobWidth"> <div class="label">Current Job</div> { $job.name } </div>

						{ #if showResumeSelectionButton }
							<a class="in-selection" href="{ $job.options ? asr.makePath('app.options-list', {id: $job.options}) : asr.makePath('app.respirator-picker', {id: $job.RSLStep}) }" bind:offsetWidth="resumeWidth" class:icon=resumeIcon>
								<div class="text">Resume <br>Respirator Selection</div>
							</a>
						{ /if }
					</div>
					<div class="inner" style="max-height: { jobMaxHeight }px;">
						<Job bind:job="$job" {asr} only="true" />
						<div style="text-align: right;"><a class="button my-info" href="{asr.makePath('app.info')}">My info</a></div>
					</div>
					
				</div>
			{ /if }

		</div>
	</div>

	<Modal bind:show="$editEL">
		{ #if manualELEdit }
			<ExposureLimitEntry />
		{ :else }
			<p>Would you like to select an exposure limit via the Chemical Tool, or enter it manually?</p>

			<div class="buttons editEL">
				<a class="button chemtool" href="{ asr.makePath('app.chemicals') }" on:click="$set({ editEL: false })">Chemical Tool</a>
				<div class="button manual" on:click="set({ manualELEdit: true })">Manually</div>
			</div>
		{ /if }
	</Modal>

	<Modal bind:show="$editTWA">
		{ #if manualTWAEdit }
			<TWAEntry />
		{ :else }
			<p>Would you like to calculate a TWA with the TWA calculator, or enter it manually?</p>

			<div class="buttons editTWA">
				<a class="button chemtool" href="{ asr.makePath(valueSources['twa']) }" on:click="$set({ editTWA: false })">TWA Calculator</a>
				<div class="button manual" on:click="set({ manualTWAEdit: true })">Manually</div>
			</div>
		{ /if }
	</Modal>

</div>

<script>

	import { store, valueSources } from 'lib/storage.js'

	export default {
		components: {
			Menu: 'lib/Menu.html',
			Job: './info/Job.html',
			Modal: 'lib/Modal.html',
			ExposureLimitEntry: 'lib/ExposureLimitEntry.html',
			TWAEntry: 'lib/TWAEntry.html'
		},
		onstate({ current }) {
			let manualELEdit = current.$editEL ? current.manualELEdit : 0
			let manualTWAEdit = current.$editTWA ? current.manualTWAEdit : 0
			this.set({ manualELEdit, manualTWAEdit })
		},
		methods: {
			focusContent() {
				this.set({ sidebarOpen: false })
				store.set({ jobOpen: false })
			},
			closeMenu(event) {
				if(event.target.nodeName == 'A') this.set({ sidebarOpen: false })
			},
			closeJob(event) {
				if(event.target.nodeName == 'A') store.set({ jobOpen: false })
			}
		},
		computed: {
			jobMaxHeight: ({ windowHeight, apertureMarginTop }) => windowHeight - apertureMarginTop - 70,
			apertureMarginTop: ({ $nav, redNavHeight }) => (($nav && $nav.sub) ? redNavHeight : 0) + 50,
			showState: ({ stateName }) => /app\.((calculate-)|(respirator-)|(chemicals)|(options))/.test(stateName),
			showResumeSelectionButton: ({ $job, stateName }) => $job.RSLStep && (stateName !== 'app.respirator-picker') && (stateName !== 'app.options-list'),
			maxResumeWidth: ({ resumeWidth, maxResumeWidth }) => Math.max(resumeWidth, maxResumeWidth),
			resumeIcon: ({ maxResumeWidth, currentJobWidth, windowWidth }) => (maxResumeWidth && currentJobWidth) ? maxResumeWidth + currentJobWidth > windowWidth ? true : false : false
		},
		store: () => store,
		oncreate () {

			// console.log = console.error = m => {
			// 	let div = document.createElement('div')
			// 	div.innerText = m 
			// 	document.getElementById('domlog').appendChild(div)
			// }

			let editing = false
			window.addEventListener('focusin', () => editing = true)
			window.addEventListener('focusout', () => editing = false)

			function direction({x, y}) {
				let threshold = 1 // pixels (arbitrary)
				if(x - Math.abs(y) > threshold) return 'right'
				else if(y - Math.abs(x) > threshold) return 'down'
				else if(Math.abs(x) - Math.abs(y) > threshold) return 'left'
				else if(Math.abs(y) - Math.abs(x) > threshold) return 'up'
			}

			var prev = false, initialDirection = false, movement = {}

			window.addEventListener('touchstart', () => {prev = event; initialDirection = false}, false )
			window.addEventListener('touchend', () => up(), false )
			window.addEventListener('touchcancel', () => up(), false )

			const up = () => {
				prev = false

				if(window.tableDragging || editing || (movement.x == 0 && movement.y == 0)) return

				let latestDirection = direction(movement)
				let { wrapperX } = this.get()

				if(!!~['left', 'right'].indexOf(initialDirection)) {
					if(latestDirection == 'right') this.set({ sidebarOpen: true })
					else if(latestDirection == 'left') this.set({ sidebarOpen: false })
					else this.set({ sidebarOpen: wrapperX > -150 }) // either side of halfway
				}

				movement = {x:0, y:0}
			}

			window.addEventListener('touchmove', e => {
				if(window.tableDragging || editing) return

				event = e.originalEvent || e
				if(event.scale !== 1) {
					return
				}

				e.stopPropagation()
				let event = e.touches ? e.touches[0] : e

				movement.x = event.clientX - prev.clientX
				movement.y = event.clientY - prev.clientY
				prev = event

				if(!initialDirection) initialDirection = direction(movement)

				let { wrapperX } = this.get()

				// drag around
				if(initialDirection == 'right' || initialDirection == 'left') {
					this.set({ wrapperX: Math.max(Math.min(wrapperX + movement.x, 0), -300) })
				}
			}, false)

			const closeTo = (a, b) => a > (b-.1) && a < (b+.1)
			const snapTo = (a, b) => closeTo(a, b) ? b : a

			const renderSlide = () => {

				let { wrapperX, jobY, sidebarOpen, jobHeight } = this.get()
				let { jobOpen } = store.get()

				let target = sidebarOpen ? 0 : -300
				if(!prev && target !== wrapperX) wrapperX += (target - wrapperX) * .3

				wrapperX = snapTo(wrapperX, -300)
				wrapperX = snapTo(wrapperX, 0)

				if(jobHeight) {
					let target2 = jobOpen ? -jobHeight : 0
					if(target2 !== jobY) jobY += (target2 - jobY) * .3

					// jobY = snapTo(jobY, -jobHeight)
					jobY = snapTo(jobY, 0)
				}

				this.set({ wrapperX, jobY })
			}

			function render() {
				renderSlide()
				window.requestAnimationFrame(render)
			}
			render()

			// use event bubbling to make all external links open in new tab
			window.addEventListener('click', e => {
				if(e.target.tagName !== 'A') return true
				const a = e.target

				if(a.href && a.host !== window.location.host && a.href.indexOf('javascript:') === -1) {
					e.preventDefault()
					e.stopPropagation() 
					window.open(a.href, '_blank')
				}
			})

			const stateChange = e => {
				this.set({ stateName: e.state.name, sidebarOpen: false })
				store.set({ jobOpen: false })
			}

			// captures event from router
			this.on('stateChange', stateChange)
			stateChange(this.get().initialState)

			// disable zoom on iOS > 9
			// document.addEventListener('touchmove', function(event) {
			// 	event = event.originalEvent || event;
			// 	if(event.scale !== 1) {
			// 	  event.preventDefault();
			// 	}
			// }, false);

			if (/iP(hone|od|ad)/.test(navigator.platform)) {
				// supports iOS 2.0 and later: <http://bit.ly/TJjs1V>
				var v = (navigator.appVersion).match(/OS (\d+)_(\d+)_?(\d+)?/);
				window.iOSversion = [parseInt(v[1], 10), parseInt(v[2], 10), parseInt(v[3] || 0, 10)][0]
			}

		},
		data: () => ({
			jobY: 0,
			wrapperX: -300,
			maxResumeWidth: 0,
			resumeWidth: 0,
			valueSources
		})
	}

</script>

<style>

	@import "colors";

	.maxwidth {
		position:absolute;
		top: 0;
		bottom: 0;
		left: 0;
		right: 0;
		max-width: 800px;
		margin: 0 auto;
		overflow:hidden;

		/* modal */
		:global(> .fixed) {
			left: 0;
		}
	}

	.wrapper {
		position: absolute;
		top: 0;
		right: 0;
		bottom: 0;
		left: 0;
		width: calc(100% + 300px);

		.main {
			position: absolute;
			top: 50px;
			right: 0;
			left:0;
			bottom: 0;
			overflow-y: auto;
			overflow-x: hidden;

			&.locked {
				overflow: hidden;
			}
		}
		
		.nav-button {
			position: absolute;
			top: 0;
			height: 50px;
			text-indent: -99999px;
			overflow: hidden;
			text-decoration: none;

			&::before {
				text-indent: 0;
				width: 50px;
				font-size: 30px;
				line-height: 50px;
				color: #fff;
				background: $blue3;
				cursor: pointer;
				text-align: center;
				display: block;
			}

			&.back {
				z-index: 2;
				&::before {
					margin-left: -2px;
				}
			}
			&.home {
				right: 0;
			}
		}

		.left {
			position: absolute;
			top: 0;
			right: calc(100% - 300px); 
			bottom: 0;
			left: 0;
			background: $blue3;
			color: #fff;
			font-size: 14px;

			.nav-button {
				left: auto;
				right: 0;

				&::before {
					background: $blue5;
				}
			}
		}

		.right {
			position: absolute;
			top: 0;
			right: 0;
			bottom: 0;
			left: 300px;
			z-index: 3;

			.elsewhere {
				display: none;
				position:absolute;
				top:0;
				right:0;
				bottom:0;
				left:0;
				z-index: 3;
				background: rgba(255,255,255,0.2);
			}

			nav {
				width: 100%;
				height: 50px;
				background: $blue3;

				.title {
					display: table;
					width: 100%;
					.inner {
						display: table-cell;
						text-align: center;
						font-family: "Roboto Condensed";
						text-transform: uppercase;
						color: #fff;
						height: 50px;
						vertical-align: middle;
					}
				}
			}

			.rednav {
				position: relative;
				background: $red4;
				width:100%;

				.title {
					display: table;
					color: #fff;
					width: 100%;

					.inner {
						display: table-cell;
						text-align: center;
						font-family: "Roboto Condensed";
						color: #fff;
						padding: 10px 40px;
						line-height: 20px;
						vertical-align: middle;
					}
				}

				.prev, .next {
					position: absolute;
					top: 50%;
					margin-top: -20px;

					a { 
						padding: 0;
						display: block;
						width: 26px;
						height: 26px;
						text-align: center;
						line-height: 26px;
						color: #fff;
						text-decoration: none;
						font-size: 26px;
						margin: 7px 10px;

						.text {
							text-indent: -9999px;
							display: block;
						}
					}
				}
				.prev { left: 0; }
				.next { right: 0; }
			}

			.state {
				position: absolute;
				top: 100%;
				left: 0;
				right: 0;
				background: #fff;
				z-index: 4;

				.header {
					cursor: pointer;
					position: relative;
					margin-top: -50px;
					background: #fff;
					height: 50px;
    				box-shadow: 0px 0px 10px #bbb;

					.current-job {
						color: $green;
						height: 50px;
						line-height: 1.4;
						padding-left: 42px;
						background-image: url(icons/my-info-colored.png);
						background-size: 26px;
						background-position: 8px center;
						background-repeat: no-repeat;
						display: inline-block;
						vertical-align: middle;
						white-space: nowrap;

						.label {
							font-size: 10px;
							text-transform: uppercase;
							font-weight: bold;
							margin-top: 8px;
						}
					}

					.in-selection {
						background: #fff;
						padding-left: 44px;
						color: #4c5a8d;
						position: absolute;
						right: 0;
						top: 0;
						height: 50px;
						text-decoration: none;
						background-image: url(icons/respirator-colored.png);
						background-size: 28px;
						background-position: 8px center;
						background-repeat: no-repeat;
						box-sizing: border-box;

						&.icon {
							left: calc(100% - 44px);
							right: auto;
						}

						.text {
							text-transform: uppercase;
							font-size: 10px;
							font-weight: bold;
							margin-top:11px;
							padding-right: 10px;
							line-height: 14px;
						}
					}
				}

				.inner {
					overflow: auto;

					:global(.job) {
						margin: 0;
						border-top: 1px solid #eee;
						padding-top: 10px;
					}

					.my-info {
						background: $red3;
						margin: 0 20px 20px 0;

						@media (max-width: 400px) {
							margin: 0 10px 10px 0;
						}
					}
				}
			}
		}

		&.jobOpen, &.sidebarOpen {
			.elsewhere {
				display: block;
			}
		}

		&.jobOpen {
			.job {
				box-shadow: 0px 0px 40px 0px rgba(0,0,0,0.4);
			}
		}

		&.sidebarOpen {
			.right {
				box-shadow: 0px 0px 40px 0px rgba(0,0,0,0.4);
				
				nav {
					.close {
						z-index: 1;
					}
				}
			}
		}
	}

	.appname {
		font-family: "Roboto Condensed";
		text-align: left;
		line-height: 50px;
		padding: 0 20px;
		text-transform: uppercase;
		background: $blue5;
	}

	#domlog	{
		position: absolute;
		bottom: 0;
		z-index: 1000;
	}

	.buttons.editEL {
		text-align: right;

		.chemtool { background: $red2; }
		.manual { background: #222; }
	}

	.buttons.editTWA {
		text-align: right;

		.chemtool { background: $blue2; }
		.manual { background: #222; }
	}

</style>