<div class="maxwidth">

	<div class="wrapper out{visibleSlideOut}">

		<div id="flapsleft">
		<div class="left">

			<div class="appname">Respirators 101</div>

			<div class="main">
				<Menu asr="{ asr }"></Menu>
			</div>

			{#if !visibleSlideOut}
			<div class="debutterfinger"></div>
			{/if}
		</div>
		</div>


		<div class="right">
			{#if visibleSlideOut}
			<div class="anythingelsebutton" on:click="set({visibleSlideOut: false})"></div>
			{/if}

			<nav>
				<div class="one">
					{ #if categoryParent }
					<a class="back button icon-angle-left" href="{ categoryParent }"></a>
					{ :elseif backButton }
					<a class="back button icon-angle-left" href="javascript:window.history.go(-1);"></a>
					{ :else }
						{#if visibleSlideOut}
						<button class="close icon-close"></button>
						{:else}
						<button class="menu icon-menu" on:click="set({visibleSlideOut: true})"></button>
						{/if}
					{/if}
				</div>
				<div class="title">{ title }</div>
				<div class="two"><a class="button home icon-home2" href="{ asr.makePath('app.home') }"></a></div>
			</nav>

			<div class="main">
				<uiView></uiView>
			</div>
		</div>

	</div>

	{ #if $job.RSLStep && (stateName !== 'app.respirator-picker') && (stateName !== 'app.options-list')  }
	<a class="button in-selection" href="{ asr.makePath('app.respirator-picker', {id: $job.RSLStep})}">
		Resume Respirator Selection
	</a>
	{ /if }

	<div class="job-slider" data-open="{ jobOpen }" bind:offsetHeight="jobHeight" style="{ jobOpen ? 'top: calc(100% - ' + jobHeight + 'px)' : '' }">

		<div class="alignright"><a class="button current-job" on:click="set({ jobOpen: !jobOpen })"> Current Job </a></div>

		<div class="job">
			<Job bind:job="$job" {asr} only="true" />
		</div>

	</div>

</div>

<script>

	import Menu from 'lib/Menu.html'
	import categories from 'data/categories.json'
	import posts from 'data/posts.json'
	import { store } from 'lib/storage.js'
	import Job from './info/Job.html'

	// import position from 'touch-position'

	export default {
		components: {
			Menu,
			Job
		},
		store: () => store,
		oncreate () {

			const wrapper = document.querySelector('.wrapper')
			position({x: -300, y: 0}) 

			function position({x, y}) {
				wrapper.x = x
				wrapper.y = y
				let value = `translate(${x}px, ${y}px)`
				wrapper.style.cssText = `
					-webkit-transform: ${value};
					transform: ${value};`
			}

			function direction({x, y}) {
				if(x > Math.abs(y)) {
					return 'right'
				} else if(y > Math.abs(x)) {
					return 'down'
				} else if(Math.abs(x) > Math.abs(y)) {
					return 'left'
				} else if(Math.abs(y) > Math.abs(x)) {
					return 'up'
				}
			}

			function animate(e) {
				start = {x: wrapper.x, y: wrapper.y}
				end = e
				animationStarted = Date.now()
			}

			var prev = false, initialDirection = false, movement = {}

			window.addEventListener('touchstart', down)
			window.addEventListener('touchend', up)
			window.addEventListener('touchcancel', up)

			function down() {
				prev = true
			}
			function up() {
				prev = false

				// swipe
				let latestDirection = direction(movement)
				if(latestDirection == 'right') animate({x: 0, y: 0}) // open
				else if(latestDirection == 'left') animate({x: -300, y: 0}) // closed
				else animate({x: wrapper.x > -150 ? 0 : -300, y: 0}) // either side of halfway
			}

			window.addEventListener('touchmove', move)

			function move(e) {
				if(prev === false) return
				let target = e.touches ? e.touches[0] : e

				let { clientX, clientY } = target

				// first move
 				if(prev === true) {
 					initialDirection = false
					prev = { x: clientX, y: clientY }
					return
				}
				movement.x = clientX - prev.x
				movement.y = clientY - prev.y
				if(movement.x == 0 && movement.y == 0) return

				prev = { x: clientX, y: clientY }

				if(!initialDirection) initialDirection = direction(movement)

				// drag around
				if(initialDirection == 'right' || initialDirection == 'left') {
					position({x: Math.max(Math.min(wrapper.x + movement.x, 0), -300), y: 0})
				}
			}

			var animationStarted = 0
			var start = {x: 0, y: 0}
			var end = {x: 0, y: 0}
			var animationDuration = 250 // quarter second

  			const easeOutCubic = function (t) { return (--t)*t*t+1 } 

			function renderSlide() {
				if(!prev) { // not touching
					let animationElapsed = (Date.now() - animationStarted) / animationDuration
					if(animationElapsed > 1.1) return

					let ease = animationElapsed < 1 ? easeOutCubic(animationElapsed) : 1
					let move = {
						x: (end.x - start.x) * ease,
						y: (end.y - start.y) * ease
					}
					position({x: start.x + move.x, y: start.y + move.y})
				}
			}

			function render() {
				renderSlide()
				window.requestAnimationFrame(render)
			}
			render()




















			// use event bubbling to make all external links open in new tab
			this.options.target.addEventListener('click', e => {

				if(e.target.tagName !== 'a') return true

				const a = e

				if(a && a.host !== window.location.host && a.href.indexOf('javascript:') === -1) {
					// console.log(a.href.indexOf('javascript:'))
					event.preventDefault()
					event.stopPropagation() 
					window.open(a.href, '_blank')
				}

			})

			const stateChange = e => {
				var params = e.params

				if(e.state.name == 'app.categorycontent' || e.state.name == 'app.category') {
					if(params.catid && categories[params.catid]) {
						this.set({ title: categories[params.catid].title })
					}
				}

				else if(e.state.name == 'app.content') {
					if(params.id && posts[params.id]) {
						this.set({ title: posts[params.id] })
					}
				}

				else if(e.state.title) {
					this.set({ title: e.state.title })
				}

				else {
					this.set({ title: "" })
				}

				// back button for category contents
				if(params.catid && params.id) {
					this.set({ backButton: false })
					this.set({ categoryParent: this._state.asr.makePath('app.category', { catid: params.catid }) })
				} else if(e.state.route.slice(0, 9) === 'calculate' && e.state.route.length > 9) {
					this.set({ backButton: true })
					this.set({ categoryParent: false })
				} else {
					this.set({ backButton: false })
					this.set({ categoryParent: false })
				}

				this.set({visibleSlideOut: false})

				// console.log(e)

				this.set({stateName: e.state.name})

				// this.set({inSelection: 
				// 	e.state.name !== 'app.respirator-picker' && 
				// 	e.state.name !== 'app.options-list' && 
				// 	this.store.currentJob.RSLStep
				// 		? this.store.currentJob.RSLStep
				// 		: false
				// 	})
			}

			// captures event from router
			this.on('stateChange', stateChange)
			stateChange(this.get().initialState)
		}, 
		data() {
			return { 
				visibleSlideOut: false,
				title: '',
				inSelection: false,
				stateName: null,
				jobOpen: false,
				jobHeight: 0
			}
		}
	}

</script>

<style>

	@import "colors";

	.maxwidth {
		position:absolute;
		top: 0;
		bottom: 0;
		left: 0;
		right: 0;
		max-width: 800px;
		margin: 0 auto;
		overflow:hidden;
	}

	.wrapper {

		position: absolute;
		top: 0;
		right: 0;
		bottom: 0;
		left: 0;
		width: calc(100% + 300px);

		&.outtrue {
			left: 0;

			.left {
				box-shadow: 0px 0px 40px 0px #00000066;
			}
		}

	}

	.left {
		position: absolute;
		top: 0;
		right: calc(100% - 300px); 
		bottom: 0;
		left: 0;
		background: $blue3;
		color: #fff;
		font-size: 14px;
		z-index: 3;
	}

	.right {
		position: absolute;
		top: 0;
		right: 0;
		bottom: 0;
		left: 300px;
	}
	
	nav {
		width: 100%;
		height: 50px;
		background: $blue3;
		display: table;

		> div {
			display: table-cell;
			vertical-align: middle;
			color: #fff;
		}

		.one, .two {
			width: 50px;
		}
		.title {
			width: 100%;
			text-align: center;
			font-family: "Roboto Condensed";
			text-transform: uppercase;
		}
	}

	.main {
		position: absolute;
		top: 50px;
		right: 0;
		left:0;
		bottom: 0;
		overflow-y: auto;
		overflow-x: hidden;
		padding-bottom: 60px;
	}

	.appname {
		font-family: "Roboto Condensed";
		text-align: left;
		line-height: 50px;
		padding: 0 20px;
		text-transform: uppercase;
		background: $blue5;
	}

	nav {
		button, .button {
			padding: 0;
			width: 50px;
			height: 50px;
			display: block;
			border: 0;
			color: #fff;
			text-decoration: none;
			font-size: 30px;
			line-height: 50px;
			text-align: center;
			cursor: pointer;
			background: $blue3;
			background-size: 60%;
			background-repeat: no-repeat;
			background-position: center;
		}
		a.back::before {
			margin-left: -2px;
		}
	}
	.anythingelsebutton, .debutterfinger {
		position:absolute;
		top:0;
		right:0;
		bottom:0;
		left:0;
		z-index: 1;
	}

	.in-selection {
	    position: absolute;
	    z-index: 200;
	    bottom: 0;
	    max-width: 60%;
	    background: #4c5a8d;
	    padding: 13px 15px 13px 45px;
	    vertical-align: middle;
	    color: #ffffffee;
	    text-decoration: none;
	    background-image: url(icons/respirator.png);
	    background-size: 25px;
	    background-position: 8px center;
	    background-repeat: no-repeat;
	    line-height: 14px;
	    box-sizing: border-box;

	    @media (max-width: 400px) {
	    	padding: 8px 10px 8px 40px;
	    	background-size: 20px;
	    	font-size: 70%;
	    }
	}

	/*.job*/ 

	.job-slider {
		transition: all .5s ease;
		position: absolute;
		left: 0;
		right: 0;
		top: calc(100% - 40px);

		@media (max-width: 400px) {
			top: calc(100% - 30px);
	    }

		.job {
			background: #fff;
			box-shadow: 0px 0px 20px #00000099;

			:global(.job) {
				margin: 0;	
			}
		}

		.alignright {
			text-align: right;
		}

		.current-job {
			margin: 0;
			background: $green; 

		    @media (max-width: 400px) {
		    	line-height: 30px;
		    	padding: 0 8px;
		    	font-size: 70%;
		    }
		}

		&[data-open=true] {
			/*bottom: 0;*/
		}
	}

</style>