
{ #if job.id == $job.id && !only }<div class="currentJob">Current Job</div>{ /if }

<div class="job currentJob{ job.id == $job.id }">
	<div class="title">

		<div class="name">
			<span ref:name contenteditable="{ !!editingName }" on:input="updateName(this.innerText)" on:blur="set({ editingName: false })"></span>

			{ #if editingName }
				<span class="edit">[done]</span>
			{ :else }
				<span class="edit" on:click="editName()">[edit]</span>
			{ /if }
		</div>

		<div class="date">
			{ #if editingDate }
				<input type="date" bind:value="job.date" ref:date on:blur="set({ editingDate: false })"><span class="edit">[done]</span>
			{ :else }
				<span>{ date(job.date) }</span><span class="edit" on:click="editDate()">[edit]</span>
			{ /if }
		</div>

		<div class="cfx"></div>
	</div>
	<div class="content">

		<Warnings />

		<div class="read-value live{job.id == $job.id }">
			<div class="legend-cont"><div class="legend"> Exposure Limit </div></div>
				{ #if job.exposureLimit.value }
					<ExposureLimits exposureLimit="{job.exposureLimit}" />
				{ :else }
					No exposure limit selected yet!
				{ /if }
			<div class="button-cont"><div class="button" on:click="$set({ editEL: true })"> { job.exposureLimit.value ? 'Edit' : 'Add' } </div></div>
		</div>

		<div class="read-value live{job.id == $job.id }" style="text-align: center">
			<div class="legend-cont"><div class="legend"> TWA </div></div>
				{ #if job.twa.final }
					<div class="representation">
						{ round(job.twa.final) }
						<div class="unit">{ @html unitsPretty[job.twa.unit] }</div>
					</div>
				{ :else }
					No TWA set yet!
				{ /if }
			<div class="button-cont"><a class="button" href="{ asr.makePath(valueSources['twa']) }"> { job.twa.final ? 'Edit' : 'Add' } </a></div>
		</div>

		<div class="read-value live{job.id == $job.id }">
			<div class="legend-cont"><div class="legend"> HR </div></div>
				{ #if job.hr }
					{ round(job.hr) }
				{ :else }
					No HR set yet!
				{ /if }
			<div class="button-cont"><a class="button" href="{ asr.makePath(valueSources['hr']) }"> { job.hr ? 'Edit' : 'Add' } </a></div>
		</div>

		{ #if Object.keys(job.options_saved).length }
			<Table data="{ JSON.stringify([ ['Saved Respirator Options', 'APF'], ...Object.values(job.options_saved) ] ) }" />
		{ /if }
		{ #if job.options }
			<div><a class="respirator-options button" href="{ asr.makePath('app.options-list', { id: job.options }) }">All Respirator Options</a></div>
		{ /if }

	</div>

	{ #if !only }
		<div class="buttons">
			{ #if job.id !== $job.id }<div class="button switchJob" on:click="fire('switchJob', job.id)">Select</div>{ /if }
			<div class="button duplicateJob" on:click="fire('duplicate', job.id)">Duplicate</div>
			{ #if Object.keys($jobs).length > 1 }<div class="button deleteJob" on:click="fire('confirmDelete', job.id)">Delete</div>{ /if }
		</div>
	{ /if }

</div>


<script>

	import date from 'date-and-time'
	import { valueSources } from 'lib/storage.js'
	import { round, unitsPretty } from 'lib/util.js'

	export default {
		components: {
			ExposureLimits: 'lib/ExposureLimits.html',
			Warnings: 'lib/Warnings.html',
			Table: 'lib/Table.html'
		},
		oncreate() {
			this.refs.name.innerText = this.get().job.name
		},
		methods: {
			editName() {
				this.set({ editingName: true })
				this.refs.name.focus()
			},
			updateName(text) {
				let { job } = this.get()
				job.name = text 
				this.set({ job })
			},
			editDate() {
				this.set({ editingDate: true })
				this.refs.date.focus()
			}
		},
		helpers: {
			date: (d) => d ? date.format(new Date(d), 'MMM D, YYYY', true) : 'Date', 
			round
		},
		data: () => ({
			valueSources,
			only: false,
			unitsPretty
		})
	}

</script>

<style>

	@import 'colors';

	.currentJob {
		color: $green;
		font-size: 80%;
		text-transform: uppercase;
		font-weight: bold;
		margin-bottom: -10px;
		margin-top: 10px;
	}
	
	.job {
		position: relative;
		padding: 20px;
		overflow: hidden;
		margin: 10px 0;

		@media (max-width: 400px) {
			padding: 10px;
		}

		.name {
			float:left;
			span[contenteditable=true] {
				outline: 1px solid #666;
    			outline-offset: 3px;
			}
		}
		.cfx {
			clear:both;
			content: ' ';
		}

		.content {
			margin-top: 10px;
			padding: 0;
		}

		.edit {
			font-size: 80%;
			color: #4260b5;
			cursor: pointer;
			font-weight: 400;
			margin-left: 5px;
		}
		.date {
			float:right;
		}

		&.currentJobtrue {
			background: #fff;
			/*border-color: color($green l(+20%));*/

			.legend {
				background: #fff;
			}
		}

		&.currentJobfalse {
			.edit {
				display: none;
			}
		}

		.buttons {
			margin-top: 10px;
			text-align: right;
		}

		.deleteJob.button {
			background: $red2;
			&:active {
				background: linear-gradient(color($red2 l(-5%)), color($red2 l(+5%)));
			}
		}

		.duplicateJob.button {
			background: $blue2;
			&:active {
				background: linear-gradient(color($blue2 l(-5%)), color($blue2 l(+5%)));
			}
		}

		.switchJob.button {
			background: $green;
			&:active {
				background: linear-gradient(color($green l(-5%)), color($green l(+5%)));
			}
		}

		.respirator-options.button {
			/*margin-top: 20px;*/
			background: $red2;
		}

		/* slightly less awkward layout */
		/*.clump {
		    display: inline-block;
		    width: 100px;
		}*/

		.read-value {
			margin: 10px 0;
		}

		:global(table) {
			width: 100%;
			margin-bottom: 0;
			/*margin-top: 10px;*/
			font-size: 90%;
		}
	}

</style>