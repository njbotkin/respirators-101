
<div id=content>

	<p>A Time-Weighted Average (TWA) is used to measure a worker's daily exposure to hazardous substances, averaged over an 8- or 10-hour workday. </p>

	<img class="latex" src="images/twa.svg" />

	<p class="latex-desc">where <i>t</i> is the measurement duration, and <i>c</i> is the measurement concentration.</p>

	<p>The average is calculated from:</p>

	<ol>
		<li>Air samples taken during the workday.</li>
		<li>Work time represented by the sample.</li>
	</ol>

	<p>To calculate the TWA:</p>

	<div class="indent">
		<strong>Step 1:</strong> Choose an exposure limit (NIOSH REL or other).<br>
		<strong>Step 2:</strong> Select "Add Sample".<br>
		<strong>Step 3:</strong> Enter sample information.<br>
		<strong>Step 4:</strong> Continue adding samples and information until all samples have been entered.<br>
		<strong>Step 5:</strong> Select "Save TWA" to save to your Current Job in My Info.
	</div>

	<p><em>NOTE ON HOURS: Take into account time when workers were NOT exposed to the hazard (for instance, on breaks). If a sample was taken at 11am and then again at 2pm, but the lunch hour was between 12pm and 1pm, the sample only represents 2 work hours.</em></p>

</div>

<div class="read-value">
	<div class="legend-cont"><div class="legend"> Exposure Limit </div></div>

	{ #if $job.exposureLimit.value }
		<ExposureLimits exposureLimit="{ $job.exposureLimit }" />
	{ :else }
		No exposure limit selected yet!
	{ /if }

	<div class="button-cont"><div class="button edit" on:click="$set({ editEL: true })"> Edit </div></div>
</div>

{ #if $job.exposureLimit.value }

	<div class="samples">

		{ #if $job.twa.unit }
			<table>
				<thead>
					<tr>
						<th></th><th>{ @html unitsPretty[$job.twa.unit] } <br>Measured</th><th></th><th>{ $job.exposureLimit.timeUnit } <br>Represented</th><th></th><th>{ @html unitsPretty[$job.twa.unit] }-<br>{ $job.exposureLimit.timeUnit }</th><th></th>
					</tr>
				</thead>
				<tbody>

				{ #each $job.twa.samples as sample, i }
					<tr class="sample">
						<td><label><span class="optional">Sample </span>{i + 1}</label></td>
						<td><input type="number" bind:value="sample.value" placeholder="0" /></td>
						<td>&#215;</td>
						<td><input type="number" bind:value="sample.period" placeholder="0" /></td>
						<td>=</td>
						<td><div class="result">{ round($job.twa.sampleProducts[i] / $job.exposureLimit.timeUnitMultiplier) }</div></td>
						<td><div class="removeSample" on:click="removeSample(i)">&#215;</div></td>
					</tr>
				{ /each }
					
				</tbody>
			</table>
		{ /if }

		<div style="text-align: center"><div class="addSample" on:click="addSample()">[ Add sample + ]</div></div>

		{ #if $job.warnings['unit-mismatch'] }
			<div class="convert-units">
				Click here to convert your {@html unitsPretty[$job.twa.unit] } measurements to {@html unitsPretty[$job.exposureLimit.unit] } measurements: 
				<div class="button convert" on:click="$set({ job: { twa: { unit: $job.exposureLimit.unit } } })">Convert Units</div>
			</div>
		{ /if }
	</div>

	<Warnings />

	{ #if $job.twa.final }
		<div class="save-value livetrue">
			<div class="legend-cont"><div class="legend">TWA</div></div>

			<div class="equation">

				<div class="operand">
					<div class="value">{ round($job.twa.totalValueMinutes / $job.exposureLimit.timeUnitMultiplier) }</div>
					<div class="unit">Total <br>{ @html unitsPretty[$job.twa.unit] }-{ $job.exposureLimit.timeUnit }</div>
				</div>

				<div class="operator">&#247;</div>

				<div class="operand">
					<div class="value">{ round($job.twa.totalMinutes / $job.exposureLimit.timeUnitMultiplier) }</div>
					<div class="unit">Total <br>{ $job.exposureLimit.timeUnit }</div>
				</div>

				<div class="operator">=</div>

				<div class="operand">
					<div class="value">{ round($job.twa.final) }</div>
					<div class="unit">TWA</div>
				</div>

			</div>

			<div class="button-cont"><div class="button"> Current TWA  </div></div>
		</div>
	{ /if }

{ :else }

	<div class="description content">
		<p>Please select an exposure limit first.</p>
	</div>

{ /if }


<script>

import { round, unitsPretty } from 'lib/util.js'
import { valueSources } from 'lib/storage.js'

export default {
	components : {
		ExposureLimits: 'lib/ExposureLimits.html',
		Warnings: 'lib/Warnings.html'
	},
	oncreate() {
		// let samples = this.store.get().job.twa.samples
		// if(samples.length === 0) {
		// 	samples.push({
		// 		value: '',
		// 		period: ''
		// 	})
		// }
		// this.store.set({ job: { twa: { samples } } })
	},
	methods: {
		addSample() {
			let samples = this.store.get().job.twa.samples
			samples.push({
				value: '',
				period: ''
			})
			this.store.set({ job: { twa: { samples } } })
		},
		removeSample(i) {
			let samples = this.store.get().job.twa.samples
			samples.splice(i, 1)
			this.store.set({ job: { twa: { samples } } })
		}
	},
	helpers: {
		round
	},
	data: () => ({
		valueSources,
		unitsPretty
	})
}

</script>

<style>

	@import 'colors';

	.latex {
		margin: 30px auto 20px;
		max-width: 170px;

		@media (max-width: 600px) {
			max-width:150px;
		}

	}
	.latex-desc {
		max-width: 300px;
		margin: 20px auto 30px;
		font-style: italic;
		font-size: 90%;
		color: #666;

		i {
			font-style: normal;
		}
	}

	.samples {
		border: 1px solid #aaa;
		display: table;
		padding: 15px;
		margin: 20px auto 0;
	}

	table {
		margin: 0 auto 15px;

		th {
			font-weight: normal;
			color: #666;
			line-height: 1.2;
			font-size: 90%;
		}

		.sample {

			label {
				font-size: 90%;
				font-weight: bold;
				color: $blue2;
			}

			input {
				display: inline-block;
				font-size: 110%;
				margin: 0 10px;
				width: 60px;
				line-height: 40px;
				padding: 0 10px;
				border: 1px solid #aaa;

				@media screen and (max-width: 400px) {
					line-height: 30px;
					padding: 0 5px;
					width: 40px;
				}
			}

			.result {
				display: inline-block;
				font-size: 110%;
				margin: 0 10px;
			}

			.removeSample {
				display:block;
				width: 20px;
				text-align: center;
				color: #fff;
				background: $red2;
				cursor: pointer;
				font-size: 14px;
				line-height: 20px;
				border-radius: 100%;
				vertical-align: middle;
			}

		}
	}

	.addSample {
		font-size: 80%;
		color: #4260b5;
		cursor: pointer;
		font-weight: 400;
	}

	@media screen and (max-width: 400px) {
		.optional {
			display: none;
		}
	}

	.convert-units {
		max-width: 400px;
	    display: block;
	    font-size: 90%;
	    margin-top: 10px;
	}

	.button.convert {
		background: $blue2;
		line-height: 30px;
		padding: 0 10px;
		margin-left: 3px;
	}

	.save-value, .read-value {
		display: table;
		margin: 0 auto;
	}
	.save-value {
		margin-top: 20px;
	}

</style>