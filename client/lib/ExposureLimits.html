{ #if showKeys }
	<div class="keys">
		<div class="key form">Form</div>
		<div class="key standard">Standard</div>
		<div class="key duration">Measurement duration</div>
		<div class="key EL">Exposure Limit</div>
	</div>
{ /if }

<div class="property-list">
	{ #each Object.entries(ELs) as [formKey, form] }

		<div class="property color-form"> 
			<div class="label">{ formsPretty[formKey] }</div>
			<div class="value">

				{ #each Object.entries(form) as [standardKey, standard] }

					<div class="property color-standard">
						<div class="label">{ standardsPretty[standardKey] }</div>
						<div class="value property-list">

							{ #if standard.durations }{ #each Object.entries(standard.durations) as [durationKey, duration] }

								<div class="property color-duration">
									<div class="label">{ durationsPretty[durationKey] }</div>
									<div class="value">

										{ humanTime(durations[standardKey][durationKey]) }

										{ #each Object.entries(duration) as [unit, value] }

											<div class="representation select-el EL" on:click="fire('confirmSaveEL', { formKey, standardKey, durationKey, value, unit, duration: durations[standardKey][durationKey] })" data-active="{ elSame({ formKey, standardKey, durationKey, value, unit, duration: durations[standardKey][durationKey] }, $job.exposureLimit) }">
												{ value }
												<div class="unit">{ @html unitsPretty[unit] }</div>
											</div>

										{ /each }

									</div>
								</div>

							{ /each }{ /if }

						</div>

						{ #if standard.carcinogens }
							<span class="carcinogens">carcinogens</span>
						{ /if }

						{ #if standard.znotes }
							{ #each standard.znotes as znote }
								<div class="notes">{@html znote }</div>
							{ /each }
						{ :elseif standard.notes }
							{ #each standard.notes as note }
								<div class="notes">{@html note }</div>
							{ /each }
						{ /if }

					</div>

				{ /each }

			</div>

		</div>

	{ /each }
</div>

<script>

	import { unitsPretty } from 'lib/util.js'

	function objectsShallowEquivalence(a, b) {
		for(let k in a) if(a[k] !== b[k]) return false
		return true
	}

	export default {
		helpers: {
			humanTime: time => time >= 60 ? (time/60) + ' hours' : time + ' minutes',
			elSame: objectsShallowEquivalence
		},
		computed: {
			// transform a single exposure limit into a structure that plays nice with the loop
			ELs: ({ forms, exposureLimit }) => {
				if(forms) {
					return forms
				}
				if(exposureLimit) {
					let mockForms = {},
						mockStandards = {},
						mockDurations = {}

					mockDurations[exposureLimit.durationKey] = {}
					mockDurations[exposureLimit.durationKey][exposureLimit.unit] = exposureLimit.value
					mockStandards[exposureLimit.standardKey] = { durations: mockDurations }
					mockForms[exposureLimit.formKey] = mockStandards

					return mockForms
				}
			}
		},
		data: () => ({
			showKeys: false,
			forms: false,
			exposureLimit: {},
			formsPretty: {
				regular: 'Gas/Vapor',
				total: 'Total dust',
				resp: 'Respirable fraction',
				'Total dust': 'Total dust',
				'Respirable fraction': 'Respirable fraction'
			},
			standardsPretty: {
				osha_pel: "OSHA PEL",
				cal_osha_pel: "Cal/OSHA PEL 8-hour TWA",
				niosh_rel: "NIOSH REL Up to 10-hour TWA"
			},
			durationsPretty: {
				regular: "Standard",
				ceiling: "Ceiling",
				stel: "STEL"
			},
			unitsPretty,

			// durations in minutes
			durations: {
				osha_pel: {
					regular: 8 * 60,
					ceiling: 8 * 60,
					stel: 15
				},
				cal_osha_pel: {
					regular: 8 * 60,
					ceiling: 8 * 60,
					stel: 15
				},
				niosh_rel: {
					regular: 10 * 60,
					ceiling: 10 * 60,
					stel: 15
				}
			}
		})
	}

</script>

<style>

	@import 'colors';

	$formSolid: $yellow1;
	$formText: $yellow2;

	$standardSolid: #8392ca;
	$standardText: #7580AA;

	$durationSolid: #999;
	$durationText: #666;

	$ELSolid: $red1;
	$ELText: #ce817f;

	.key {
		display: inline-block;
		line-height: 1;
		border-left: 12px solid;
		font-size: 12px;
		font-weight: bold;
		padding: 0 4px;
	}

	.select-el {
		cursor: pointer;
		padding: 5px;
		border: 1px solid;

		&:hover {
			background: #eee;
		}

		&.active {
			background: $ELSolid;
			color: #fff;
		}
	}

	.property.color-form, .form {
		border-color: $formSolid;
		color: $formText; 
	}

	.property.color-standard, .standard {
		border-color: $standardSolid;
		color: $standardText;
	}

	.property.color-duration, .duration {
		border-color: $durationSolid;
		color: $durationText;
	}

	.property.color-EL, .EL {
		border-color: $ELSolid;
		color: $ELText;
	}

	.representation {
		vertical-align: middle;
		margin: 4px;

		&[data-active=true] {
			background: $ELText;
			color: #fff;
		}
	}

</style>