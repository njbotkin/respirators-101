<div use:zoomy class="mask" style="height: {maskHeight}px" class:zoomy=zoomy>
	<div class="expandEvent"></div>
	<table class="{class}" style="-webkit-transform: scale({z}); transform: scale({z}); -webkit-transform-origin: left top;
		transform-origin: left top;">
		<thead>
			{ #each head as cell, i }
				<th class="col_{i}">{@html cell }</th>
			{ /each }
		</thead>
		<tbody>
			{ #each body as row }
				<tr>
					{ #each row as cell, i }
						<td class="col_{i}">{@html cell }</td>
					{ /each }
				</tr>
			{ /each }
		</tbody>
	</table>
</div>

<style>

.mask {
	overflow-x: auto;
	overflow-y: hidden;
	margin: 20px 0;
	/*touch-action: manipulate; */
	/*.shadow {
		position: absolute;
		top: 0; right: 0;
		left: 0; bottom: 0;
		transition: all .5s;
		pointer-events: none;
	}

	&.zoomy {
		.shadow {
			box-shadow: inset 0px 0px 20px rgba(0, 0, 0, 0.25);
		}
	}*/
}

table {
	font-size: 90%;
	border-collapse: collapse;
	border-spacing: 0;
	min-width: 600px;
	height: 200px;
	/*touch-action: manipulate;*/

	th {
		text-align: left;
	    vertical-align: bottom;
	}

	th, td {
		padding: 10px;
	}

	tr:nth-child(odd) {
		background: #ddd;
	}

	tr:nth-child(even) {
		background: #fff;
	}
}

</style>

<script>

// import panzoom from 'pan-zoom'
import pinch from 'touch-pinch'

export default {
	actions: {
		zoomy: (mask) => {
			let expandEvent = mask.children[0]
			let table = mask.children[1]

			function preventZoom(event) {
				event = event.originalEvent || event;
				if(event.scale != undefined && event.scale !== 1) {
					event.preventDefault();
				}
			}
			function empty() {}

			const down = () => window.tableDragging = true
			const up = () => window.tableDragging = false

			const resize = () => {

				let width = table.offsetWidth
				let height = table.offsetHeight

				let maskWidth = mask.offsetWidth
				let fullScale = maskWidth/width

				this.set({ 
					zoomy: false, 
					z: fullScale, 
					maskHeight: height * fullScale, 
					height,
					fullScale 
				})

				// if(width > maskWidth) {
				// 	if(!unpanzoom) {
				// 		unpanzoom = panzoom(mask, e => {

				// 			let zDelta = -e.dz / 1000

				// 			z = Math.min(Math.max(z + zDelta, fullScale), zMax)

				// 			let xOrigin = (e.x / z) / width
				// 			let yOrigin = (e.y / z) / height

				// 			if(z !== zMax) {
				// 				let xOriginShift = zDelta * ((x - (width*z)) * xOrigin)
				// 				let yOriginShift = zDelta * ((y - (height*z)) * yOrigin)

				// 				x += xOriginShift
				// 				y += yOriginShift
				// 			}

				// 			x += e.dx
				// 			y += e.dy

				// 			// maskHeight = height*z

				// 			// clamp
				// 			x = Math.min(Math.max(x, (0 - (width * z) + maskWidth)), 0)
				// 			y = Math.min(Math.max(y, (0 - (height * z) + maskHeight)), 0)

				// 			this.set({ x, y, z, zoomy: z != fullScale })

				// 		})

				// 	}
				// } else {
				// 	if(unpanzoom) {
				// 		unpanzoom()
				// 		unpanzoom = null

				// 		mask.removeEventListener('touchstart', down, false)
				// 		mask.removeEventListener('mousedown', down, false)
				// 		mask.removeEventListener('touchend', up, false)
				// 		mask.removeEventListener('mouseup', up, false)
				// 	}
				// }

			}
			
			mask.addEventListener('touchstart', down, true)
			mask.addEventListener('mousedown', down, true)
			mask.addEventListener('touchend', up, true)
			mask.addEventListener('mouseup', up, true)

			let zMax = 1

			// iOS 10 disallows disabling zoom, so forget this
			// if(!window.iOSversion || window.iOSversion < 10) {
			let pincher = pinch(table).on('change', (dist, prev) => {
				let { z, fullScale, height } = this.get()

				z = Math.min(Math.max(z + ((dist - prev) / 500), fullScale), zMax)

				this.set({ z, maskHeight: height * z, zoomy: z != fullScale })
			})
			// }

			window.addEventListener('resize', resize)
			resize()

			expandEvent.addEventListener('expanded', resize)

			// fixes weird safari 10 bug where preventDefault is prevented
			// @see https://github.com/metafizzy/flickity/issues/457#issuecomment-254501356
			window.addEventListener('touchmove', empty);

			// disable zoom on iOS > 9
			mask.addEventListener('touchmove', preventZoom, false);

			return {
				destroy: () => {

					mask.removeEventListener('touchstart', down, true)
					mask.removeEventListener('mousedown', down, true)
					mask.removeEventListener('touchend', up, true)
					mask.removeEventListener('mouseup', up, true)

					pincher.disable()

					window.removeEventListener('resize', resize)

					expandEvent.removeEventListener('expanded', resize)
					window.removeEventListener('touchmove', empty);
					mask.removeEventListener('touchmove', preventZoom, false);

				}
			}
		}
	},
	computed: {
		head: ({ data }) => JSON.parse(data).shift(),
		body: ({ data }) => JSON.parse(data).slice(1)
	}
}

</script>
